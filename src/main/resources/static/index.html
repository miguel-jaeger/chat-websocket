<!DOCTYPE html>
<html lang="es">
    <head>
        <title>Chat - Proyecto Mensajeria</title>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
            rel="stylesheet" />
        <style>
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f8f9fa;
        }
        #chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        #messages {
            flex-grow: 1;
            overflow-y: auto;
            resize: none;
            background-color: white;
        }
        .message-input-group {
            background-color: #ffffff;
        }
    body {
    min-height: max(884px, 100dvh);
    }
    </style>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
<div class="container-fluid p-0" id="chat-container">
<header class="p-3 bg-primary text-white text-center">
<h1>Chat App</h1>
</header>
<div class="p-3">
<textarea class="form-control" id="messages" ></textarea>
</div>
<footer class="p-3 message-input-group">
<div class="input-group mb-3">
<span class="input-group-text">Username</span>
<input class="form-control" id="username" placeholder="Enter your name" type="text" value="John Doe"/>
</div>
<div class="input-group">
<input class="form-control" id="message" placeholder="Type a message..." type="text" onkeypress="if(event.keyCode==13) sendMessage()"/>
<button class="btn btn-primary" id="sendButton" type="button">
<i class="material-icons">send</i>
</button>
</div>
</footer>
</div>

        <script>
        var stompClient = null;
        var socket = new SockJS('/ws'); // 1. Conexión al endpoint de Spring Boot
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function onConnected(frame) {
            console.log('Conectado al Broker STOMP: ' + frame);
            
            // 2. Suscripción: El cliente escucha el canal público para recibir mensajes
            stompClient.subscribe('/topic/public', onMessageReceived); 
        });

        function sendMessage() {
            var messageInput = document.getElementById('message');
            var content = messageInput.value;
            var sender = document.getElementById('username').value;

            if(content && stompClient) {
                var chatMessage = {
                    sender: sender,
                    content: content
                };
                
                // 3. Envío: Publicar el mensaje al Controller para procesamiento
                stompClient.send("/app/send", {}, JSON.stringify(chatMessage)); 
                messageInput.value = ''; // Limpiar input
            }
        }

        function onMessageReceived(payload) {
            // 4. Recepción: Mostrar el mensaje recibido del broker
            var message = JSON.parse(payload.body);
            var messagesDiv = document.getElementById('messages');
            
            var p = document.createElement('p');
            p.className = 'message-entry';
            p.innerHTML = `<strong>[${message.time}] ${message.from}:</strong> ${message.text}`;
            messagesDiv.appendChild(p);
            messagesDiv.scrollTop = messagesDiv.scrollHeight; 
        }
    </script>
    </body>
</html>